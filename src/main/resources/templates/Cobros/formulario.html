<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${cobro?.id == null ? 'Nuevo Cobro' : 'Editar Cobro'}">Cobros</title>

  <!-- Bootstrap -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Select2 (buscador de clientes) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <style>.oculto{display:none}</style>
</head>

<body class="p-4">
<div class="container">
  <h4 th:text="${cobro?.id == null ? 'Nuevo Cobro' : 'Editar Cobro'}"></h4>

  <form th:action="@{/cobros/guardar}" method="post" class="mt-3">
    <input type="hidden" name="id" th:value="${cobro.id}">

    <!-- =================== Cliente =================== -->
    <div class="mb-3">
      <label class="form-label">Cliente</label>
      <select id="clienteSel" name="cliente.id" class="form-select" required>
        <option value="">— Seleccione —</option>
        <option th:each="cl : ${clientes}" th:value="${cl.id}"
                th:selected="${cobro.cliente?.id == cl.id}"
                th:text="${cl.razonSocial + ' (' + cl.ruc + ')'}">
        </option>
      </select>
    </div>

    <!-- =================== Monto ===================== -->
    <div class="mb-3">
      <label class="form-label">Monto</label>
      <input type="number" step="0.01" name="monto" class="form-control"
             th:value="${cobro.monto}" required>
    </div>

    <!-- ================= Medio de pago =============== -->
    <div class="card mb-4">
      <div class="card-header fw-bold">Medio de Pago</div>
      <div class="card-body">

        <!-- Tipo -->
        <div class="mb-3">
          <label class="form-label">Tipo</label>
          <select id="tipoPago" name="tipoPago.id" class="form-select" required>
            <option value="">— Seleccione —</option>
            <option th:each="tp : ${tiposPago}" th:value="${tp.id}"
                    th:selected="${cobro.tipoPago?.id == tp.id}"
                    th:text="${tp.descripcion}"></option>
          </select>
        </div>

        <!-- EFECTIVO -->
        <div id="secEfectivo" class="mb-3 oculto">
          <label class="form-label">Banco / Caja</label>
          <select name="banco.id" class="form-select" disabled>
            <option value="">—</option>
            <option th:each="b : ${bancos}" th:value="${b.id}"
                    th:selected="${cobro.banco?.id == b.id}"
                    th:text="${b.descripcion}"></option>
          </select>
        </div>

        <!-- TARJETA -->
        <div id="secTarjeta" class="mb-3 oculto">
          <div class="d-flex justify-content-between">
            <label class="form-label">Tarjeta</label>
            <button type="button" class="btn btn-sm btn-outline-primary"
                    onclick="popupTarjeta()">Nueva</button>
          </div>
          <select id="comboTarjeta" name="tarjeta.id" class="form-select" disabled>
            <option value="">—</option>
            <option th:each="t : ${tarjetas}" th:value="${t.id}"
                    th:selected="${cobro.tarjeta?.id == t.id}"
                    th:text="${t.nombreTarjeta + ' (' + t.numeroEnmascarado + ')'}">
            </option>
          </select>
        </div>

        <!-- CHEQUE -->
        <div id="secCheque" class="mb-3 oculto">
          <div class="d-flex justify-content-between">
            <label class="form-label">Cheque</label>
            <button type="button" class="btn btn-sm btn-outline-primary"
                    onclick="popupCheque()">Nuevo</button>
          </div>
          <select id="comboCheque" name="cheque.id" class="form-select" disabled>
            <option value="">—</option>
            <option th:each="c : ${cheques}" th:value="${c.id}"
                    th:selected="${cobro.cheque?.id == c.id}"
                    th:text="${c.numeroCheque + ' - ' + c.titular}">
            </option>
          </select>
        </div>

      </div>
    </div>

    <button class="btn btn-success" type="submit">Guardar Cobro</button>
    <a href="/cobros" class="btn btn-secondary">Cancelar</a>
  </form>
</div>

<!-- ========= JS utilidades ========= -->
<script th:inline="javascript">
/*<![CDATA[*/
  const bancos = [[${bancosJS}]];
/*]]>*/
</script>

<script>
/* ---------- Select2 para búsqueda de clientes ---------- */
document.addEventListener('DOMContentLoaded', () => {
  $('#clienteSel').select2({
    theme: 'bootstrap-5',
    width: '100%',
    placeholder: 'Buscar cliente…'
  });
});

/* ---------- Mostrar/ocultar & habilitar selects ---------- */
const selTipo = document.getElementById('tipoPago');
const secEf   = document.getElementById('secEfectivo');
const secTar  = document.getElementById('secTarjeta');
const secChe  = document.getElementById('secCheque');

function refrescar() {
  const txt = selTipo.options[selTipo.selectedIndex].text;

  secEf .classList.toggle('oculto', txt !== 'EFECTIVO');
  secTar.classList.toggle('oculto', txt !== 'TARJETA');
  secChe.classList.toggle('oculto', txt !== 'CHEQUE');

  document.querySelector('[name="banco.id"]').disabled   = (txt !== 'EFECTIVO');
  document.querySelector('[name="tarjeta.id"]').disabled = (txt !== 'TARJETA');
  document.querySelector('[name="cheque.id"]').disabled  = (txt !== 'CHEQUE');
}
document.addEventListener('DOMContentLoaded', refrescar);
selTipo.addEventListener('change', refrescar);

/* -------- Alta rápida de Tarjeta -------- */
function popupTarjeta(){
  const options = bancos.map(b=>`<option value="${b.id}">${b.desc}</option>`).join('');
  Swal.fire({
    title:'Nueva Tarjeta',
    html:`<select id="tBanco" class="swal2-select mb-2">${options}</select>
          <input id="tNom" class="swal2-input" placeholder="Nombre (Visa)">
          <input id="tNum" class="swal2-input" placeholder="****-1234">
          <input id="tTit" class="swal2-input" placeholder="Titular">
          <input id="tVenc"class="swal2-input" placeholder="Venc. AAAA-MM-DD">`,
    confirmButtonText:'Guardar',
    showCancelButton:true,
    preConfirm:()=>{
      const data={
        bancoId           :document.getElementById('tBanco').value,
        nombreTarjeta     :document.getElementById('tNom').value,
        numeroEnmascarado :document.getElementById('tNum').value,
        titular           :document.getElementById('tTit').value,
        fechaVenc         :document.getElementById('tVenc').value
      };
      return fetch('/tarjetas/api',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(data)
      }).then(r=>r.json())
       .catch(()=>Swal.showValidationMessage('Error al guardar'));
    }
  }).then(res=>{
    if(res.isConfirmed){
      const c=document.getElementById('comboTarjeta');
      c.insertAdjacentHTML('beforeend',
        `<option value="${res.value.id}" selected>${res.value.label}</option>`);
      c.disabled = false;
    }
  });
}

/* -------- Alta rápida de Cheque -------- */
function popupCheque(){
  const options = bancos.map(b=>`<option value="${b.id}">${b.desc}</option>`).join('');
  Swal.fire({
    title:'Nuevo Cheque',
    html:`<select id="cBanco" class="swal2-select mb-2">${options}</select>
          <input id="cNum" class="swal2-input" placeholder="Número">
          <input id="cTit" class="swal2-input" placeholder="Titular">
          <input id="cMon" class="swal2-input" placeholder="Monto">
          <input id="cEmi" class="swal2-input" placeholder="Emisión AAAA-MM-DD">
          <input id="cPag" class="swal2-input" placeholder="Pago AAAA-MM-DD">`,
    confirmButtonText:'Guardar',
    showCancelButton:true,
    preConfirm:()=>{
      const data={
        bancoId      :document.getElementById('cBanco').value,
        numeroCheque :document.getElementById('cNum').value,
        titular      :document.getElementById('cTit').value,
        monto        :document.getElementById('cMon').value,
        fechaEmision :document.getElementById('cEmi').value,
        fechaPago    :document.getElementById('cPag').value
      };
      return fetch('/cheques/api',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(data)
      }).then(r=>r.json())
       .catch(()=>Swal.showValidationMessage('Error al guardar'));
    }
  }).then(res=>{
    if(res.isConfirmed){
      const c=document.getElementById('comboCheque');
      c.insertAdjacentHTML('beforeend',
        `<option value="${res.value.id}" selected>${res.value.label}</option>`);
      c.disabled = false;
    }
  });
}
</script>
</body>
</html>
